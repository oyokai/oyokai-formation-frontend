<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - OYOKAÏ Formation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 260px;
            background: #2c3e50;
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            background: #34495e;
            text-align: center;
            border-bottom: 1px solid #34495e;
        }

        .sidebar-header h2 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.8;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            display: block;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }

        .menu-item:hover, .menu-item.active {
            background: #3498db;
            padding-left: 30px;
        }

        .menu-item i {
            margin-right: 10px;
            width: 20px;
        }

        /* ===== CONTENU PRINCIPAL ===== */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 20px;
        }

        .content-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-header h1 {
            font-size: 24px;
            color: #2c3e50;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        /* ===== SECTIONS ===== */
        .section {
            display: none;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section.active {
            display: block;
        }

        .section-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-content {
            padding: 20px;
        }

        /* ===== DASHBOARD CARDS ===== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent-color, #3498db);
        }

        .stat-card.formations::before { --accent-color: #3498db; }
        .stat-card.testimonials::before { --accent-color: #2ecc71; }
        .stat-card.contacts::before { --accent-color: #f39c12; }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }

        /* ===== TABLEAUX ===== */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* ===== BOUTONS ===== */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 2px;
        }

        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }

        .btn-success { background: #2ecc71; color: white; }
        .btn-success:hover { background: #27ae60; }

        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #e67e22; }

        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }

        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; }

        /* ===== BADGES ===== */
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-secondary { background: #e2e3e5; color: #383d41; }

        /* ===== FORMULAIRES ===== */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.25);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* ===== MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* ===== LOGIN FORM ===== */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        /* ===== LOADING ===== */
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== ALERTS ===== */
        .alert {
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid transparent;
        }

        .alert-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN FORM -->
    <div id="loginContainer" class="login-container">
        <form id="loginForm" class="login-form">
            <div class="login-header">
                <h2>Administration</h2>
                <p>OYOKAÏ Formation</p>
            </div>
            
            <div id="loginAlert"></div>
            
            <div class="form-group">
                <label for="username">Nom d'utilisateur ou Email</label>
                <input type="text" id="username" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="password">Mot de passe</label>
                <input type="password" id="password" class="form-control" required>
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                <span id="loginSpinner" class="spinner" style="display: none; width: 16px; height: 16px; margin-right: 8px;"></span>
                Se connecter
            </button>
        </form>
    </div>

    <!-- INTERFACE ADMIN -->
    <div id="adminContainer" class="admin-container" style="display: none;">
        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>OYOKAÏ Admin</h2>
                <p id="userWelcome">Bienvenue</p>
            </div>
            
            <nav class="sidebar-menu">
                <button class="menu-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="menu-item" data-section="formations">
                    <i class="fas fa-graduation-cap"></i> Formations
                </button>
                <button class="menu-item" data-section="testimonials">
                    <i class="fas fa-star"></i> Témoignages
                </button>
                <button class="menu-item" data-section="contacts">
                    <i class="fas fa-envelope"></i> Contacts
                </button>
                <button class="menu-item" data-section="users">
                    <i class="fas fa-users"></i> Utilisateurs
                </button>
                <button class="menu-item" data-section="stats">
                    <i class="fas fa-chart-bar"></i> Statistiques
                </button>
            </nav>
        </div>

        <!-- CONTENU PRINCIPAL -->
        <div class="main-content">
            <!-- HEADER -->
            <div class="content-header">
                <h1 id="pageTitle">Dashboard</h1>
                <div class="user-info">
                    <span id="currentUser">Admin</span>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Déconnexion
                    </button>
                </div>
            </div>

            <!-- DASHBOARD -->
            <div id="dashboard" class="section active">
                <div class="dashboard-grid">
                    <div class="stat-card formations">
                        <div class="stat-number" id="totalFormations">-</div>
                        <div class="stat-label">Formations</div>
                    </div>
                    <div class="stat-card testimonials">
                        <div class="stat-number" id="pendingTestimonials">-</div>
                        <div class="stat-label">Témoignages en attente</div>
                    </div>
                    <div class="stat-card contacts">
                        <div class="stat-number" id="unreadContacts">-</div>
                        <div class="stat-label">Messages non lus</div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h3>Derniers Contacts</h3>
                    </div>
                    <div class="section-content">
                        <div id="recentContacts" class="loading">
                            <div class="spinner"></div>
                            Chargement...
                        </div>
                    </div>
                </div>
            </div>

            <!-- FORMATIONS -->
            <div id="formations" class="section">
                <div class="section-header">
                    <h3>Gestion des Formations</h3>
                    <button class="btn btn-primary" onclick="openFormationModal()">
                        <i class="fas fa-plus"></i> Nouvelle Formation
                    </button>
                </div>
                <div class="section-content">
                    <div class="form-group" style="max-width: 200px; margin-bottom: 20px;">
                        <select id="formationFilter" class="form-control" onchange="loadFormations()">
                            <option value="all">Toutes les formations</option>
                            <option value="active">Actives uniquement</option>
                            <option value="inactive">Inactives uniquement</option>
                        </select>
                    </div>
                    <div id="formationsList" class="loading">
                        <div class="spinner"></div>
                        Chargement...
                    </div>
                </div>
            </div>

            <!-- TÉMOIGNAGES -->
            <div id="testimonials" class="section">
                <div class="section-header">
                    <h3>Gestion des Témoignages</h3>
                </div>
                <div class="section-content">
                    <div id="testimonialsList" class="loading">
                        <div class="spinner"></div>
                        Chargement...
                    </div>
                </div>
            </div>

            <!-- CONTACTS -->
            <div id="contacts" class="section">
                <div class="section-header">
                    <h3>Messages de Contact</h3>
                </div>
                <div class="section-content">
                    <div id="contactsList" class="loading">
                        <div class="spinner"></div>
                        Chargement...
                    </div>
                </div>
            </div>

            <!-- UTILISATEURS -->
            <div id="users" class="section">
                <div class="section-header">
                    <h3>Utilisateurs Administrateurs</h3>
                    <button class="btn btn-primary" onclick="openUserModal()">
                        <i class="fas fa-plus"></i> Nouvel Utilisateur
                    </button>
                </div>
                <div class="section-content">
                    <div id="usersList" class="loading">
                        <div class="spinner"></div>
                        Chargement...
                    </div>
                </div>
            </div>

            <!-- STATISTIQUES -->
            <div id="stats" class="section">
                <div class="section-header">
                    <h3>Statistiques Avancées</h3>
                    <select id="statsPeriod" class="form-control" style="width: auto;" onchange="loadStats()">
                        <option value="7">7 derniers jours</option>
                        <option value="30" selected>30 derniers jours</option>
                        <option value="90">90 derniers jours</option>
                    </select>
                </div>
                <div class="section-content">
                    <div id="statsContent" class="loading">
                        <div class="spinner"></div>
                        Chargement...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL FORMATION -->
    <div id="formationModal" class="modal">
        <div class="modal-content">
            <h3 id="formationModalTitle">Nouvelle Formation</h3>
            <form id="formationForm">
                <input type="hidden" id="formationId">
                
                <div class="form-group">
                    <label for="formationTitle">Titre *</label>
                    <input type="text" id="formationTitle" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="formationSlug">Slug (URL) *</label>
                    <input type="text" id="formationSlug" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="formationCategory">Catégorie</label>
                    <input type="text" id="formationCategory" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="formationDuration">Durée</label>
                    <input type="text" id="formationDuration" class="form-control" placeholder="ex: 2 jours">
                </div>
                
                <div class="form-group">
                    <label for="formationPrice">Prix (affichage)</label>
                    <input type="text" id="formationPrice" class="form-control" placeholder="ex: Sur devis">
                </div>
                
                <div class="form-group">
                    <label for="formationShortDesc">Description courte *</label>
                    <textarea id="formationShortDesc" class="form-control" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="formationFullDesc">Description complète</label>
                    <textarea id="formationFullDesc" class="form-control" rows="6"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="formationObjectives">Objectifs</label>
                    <textarea id="formationObjectives" class="form-control"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="formationTargetAudience">Public cible</label>
                    <textarea id="formationTargetAudience" class="form-control"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="formationPrerequisites">Prérequis</label>
                    <textarea id="formationPrerequisites" class="form-control"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="formationSortOrder">Ordre d'affichage</label>
                    <input type="number" id="formationSortOrder" class="form-control" value="0">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="formationActive" checked> Formation active
                    </label>
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeFormationModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL UTILISATEUR -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <h3>Nouvel Utilisateur Administrateur</h3>
            <form id="userForm">
                <div class="form-group">
                    <label for="userUsername">Nom d'utilisateur *</label>
                    <input type="text" id="userUsername" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="userEmail">Email *</label>
                    <input type="email" id="userEmail" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="userPassword">Mot de passe *</label>
                    <input type="password" id="userPassword" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="userFirstName">Prénom</label>
                    <input type="text" id="userFirstName" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="userLastName">Nom</label>
                    <input type="text" id="userLastName" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="userRole">Rôle</label>
                    <select id="userRole" class="form-control">
                        <option value="admin">Administrateur</option>
                        <option value="moderator">Modérateur</option>
                    </select>
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Créer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION & VARIABLES GLOBALES =====
        const API_BASE = window.location.origin + '/api';
        let currentUser = null;
        let currentToken = null;

        // ===== AUTH & INIT =====
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            
            // Event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('formationForm').addEventListener('submit', handleFormationSubmit);
            document.getElementById('userForm').addEventListener('submit', handleUserSubmit);
            
            // Menu navigation
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', () => navigateToSection(item.dataset.section));
            });
            
            // Auto-generate slug from title
            document.getElementById('formationTitle').addEventListener('input', function() {
                const slug = this.value.toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');
                document.getElementById('formationSlug').value = slug;
            });
        });

        function checkAuth() {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                showLogin();
                return;
            }
            
            currentToken = token;
            verifyToken();
        }

        async function verifyToken() {
            try {
                const response = await fetch(`${API_BASE}/auth/verify`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    showAdmin();
                } else {
                    localStorage.removeItem('adminToken');
                    showLogin();
                }
            } catch (error) {
                console.error('Erreur vérification token:', error);
                showLogin();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const spinner = document.getElementById('loginSpinner');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            spinner.style.display = 'inline-block';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('adminToken', data.token);
                    currentToken = data.token;
                    currentUser = data.user;
                    showAdmin();
                } else {
                    showAlert('loginAlert', data.error, 'danger');
                }
            } catch (error) {
                showAlert('loginAlert', 'Erreur de connexion', 'danger');
            } finally {
                spinner.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            currentToken = null;
            currentUser = null;
            showLogin();
        }

        function showLogin() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminContainer').style.display = 'none';
        }

        function showAdmin() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'flex';
            
            // Mettre à jour l'interface
            document.getElementById('userWelcome').textContent = `Bienvenue ${currentUser.first_name || currentUser.username}`;
            document.getElementById('currentUser').textContent = `${currentUser.first_name || currentUser.username} (${currentUser.role})`;
            
            // Charger le dashboard
            loadDashboard();
        }

        // ===== NAVIGATION =====
        function navigateToSection(section) {
            // Mettre à jour les menus
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`[data-section="${section}"]`).classList.add('active');
            
            // Mettre à jour les sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            
            // Mettre à jour le titre
            const titles = {
                dashboard: 'Dashboard',
                formations: 'Gestion des Formations',
                testimonials: 'Gestion des Témoignages',
                contacts: 'Messages de Contact',
                users: 'Utilisateurs Administrateurs',
                stats: 'Statistiques Avancées'
            };
            document.getElementById('pageTitle').textContent = titles[section];
            
            // Charger le contenu
            switch(section) {
                case 'dashboard': loadDashboard(); break;
                case 'formations': loadFormations(); break;
                case 'testimonials': loadTestimonials(); break;
                case 'contacts': loadContacts(); break;
                case 'users': loadUsers(); break;
                case 'stats': loadStats(); break;
            }
        }

        // ===== API CALLS =====
        async function apiCall(endpoint, options = {}) {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentToken}`,
                    ...options.headers
                }
            });
            
            if (response.status === 401) {
                logout();
                return null;
            }
            
            return await response.json();
        }

        // ===== DASHBOARD =====
        async function loadDashboard() {
            try {
                const data = await apiCall('/admin/dashboard');
                if (data && data.success) {
                    const stats = data.data;
                    
                    document.getElementById('totalFormations').textContent = stats.formations.total;
                    document.getElementById('pendingTestimonials').textContent = stats.testimonials.pending;
                    document.getElementById('unreadContacts').textContent = stats.contacts.unread;
                    
                    // Derniers contacts
                    const contactsHtml = stats.recentContacts.map(contact => `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                            <div>
                                <strong>${contact.name}</strong> - ${contact.email}<br>
                                <small>${contact.formation_interest || 'Demande générale'}</small>
                            </div>
                            <div>
                                <span class="badge badge-${contact.status === 'unread' ? 'warning' : 'secondary'}">
                                    ${contact.status === 'unread' ? 'Non lu' : 'Lu'}
                                </span>
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('recentContacts').innerHTML = contactsHtml || '<p>Aucun contact récent</p>';
                }
            } catch (error) {
                console.error('Erreur dashboard:', error);
            }
        }

        // ===== FORMATIONS =====
        async function loadFormations() {
            const container = document.getElementById('formationsList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Chargement...</div>';
            
            try {
                const filter = document.getElementById('formationFilter').value;
                const data = await apiCall(`/admin/formations?status=${filter}`);
                
                if (data && data.success) {
                    const formations = data.data;
                    
                    if (formations.length === 0) {
                        container.innerHTML = '<p>Aucune formation trouvée</p>';
                        return;
                    }
                    
                    const tableHtml = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Titre</th>
                                        <th>Catégorie</th>
                                        <th>Durée</th>
                                        <th>Prix</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${formations.map(formation => `
                                        <tr>
                                            <td><strong>${formation.title}</strong></td>
                                            <td>${formation.category || '-'}</td>
                                            <td>${formation.duration || '-'}</td>
                                            <td>${formation.price_display || '-'}</td>
                                            <td>
                                                <span class="badge badge-${formation.active ? 'success' : 'secondary'}">
                                                    ${formation.active ? 'Active' : 'Inactive'}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-primary btn-sm" onclick="editFormation(${formation.id})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-${formation.active ? 'warning' : 'success'} btn-sm" 
                                                        onclick="toggleFormation(${formation.id})">
                                                    <i class="fas fa-${formation.active ? 'pause' : 'play'}"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm" onclick="deleteFormation(${formation.id}, '${formation.title}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    container.innerHTML = tableHtml;
                }
            } catch (error) {
                container.innerHTML = '<p class="alert alert-danger">Erreur lors du chargement</p>';
            }
        }

        function openFormationModal(formation = null) {
            const modal = document.getElementById('formationModal');
            const form = document.getElementById('formationForm');
            
            if (formation) {
                document.getElementById('formationModalTitle').textContent = 'Modifier la Formation';
                document.getElementById('formationId').value = formation.id;
                document.getElementById('formationTitle').value = formation.title;
                document.getElementById('formationSlug').value = formation.slug;
                document.getElementById('formationCategory').value = formation.category || '';
                document.getElementById('formationDuration').value = formation.duration || '';
                document.getElementById('formationPrice').value = formation.price_display || '';
                document.getElementById('formationShortDesc').value = formation.short_description || '';
                document.getElementById('formationFullDesc').value = formation.full_description || '';
                document.getElementById('formationObjectives').value = formation.objectives || '';
                document.getElementById('formationTargetAudience').value = formation.target_audience || '';
                document.getElementById('formationPrerequisites').value = formation.prerequisites || '';
                document.getElementById('formationSortOrder').value = formation.sort_order || 0;
                document.getElementById('formationActive').checked = formation.active;
            } else {
                document.getElementById('formationModalTitle').textContent = 'Nouvelle Formation';
                form.reset();
                document.getElementById('formationId').value = '';
                document.getElementById('formationActive').checked = true;
                document.getElementById('formationSortOrder').value = 0;
            }
            
            modal.classList.add('show');
        }

        function closeFormationModal() {
            document.getElementById('formationModal').classList.remove('show');
        }

        async function handleFormationSubmit(e) {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('formationTitle').value,
                slug: document.getElementById('formationSlug').value,
                category: document.getElementById('formationCategory').value,
                duration: document.getElementById('formationDuration').value,
                price_display: document.getElementById('formationPrice').value,
                short_description: document.getElementById('formationShortDesc').value,
                full_description: document.getElementById('formationFullDesc').value,
                objectives: document.getElementById('formationObjectives').value,
                target_audience: document.getElementById('formationTargetAudience').value,
                prerequisites: document.getElementById('formationPrerequisites').value,
                sort_order: parseInt(document.getElementById('formationSortOrder').value) || 0,
                active: document.getElementById('formationActive').checked
            };
            
            const formationId = document.getElementById('formationId').value;
            const isEdit = !!formationId;
            
            try {
                const endpoint = isEdit ? `/admin/formations/${formationId}` : '/admin/formations';
                const method = isEdit ? 'PUT' : 'POST';
                
                const data = await apiCall(endpoint, {
                    method: method,
                    body: JSON.stringify(formData)
                });
                
                if (data && data.success) {
                    closeFormationModal();
                    loadFormations();
                    showAlert('formationsAlert', data.message, 'success');
                } else {
                    showAlert('formationAlert', data.error, 'danger');
                }
            } catch (error) {
                showAlert('formationAlert', 'Erreur lors de l\'enregistrement', 'danger');
            }
        }

        async function editFormation(id) {
            try {
                const data = await apiCall(`/admin/formations/${id}`);
                if (data && data.success) {
                    openFormationModal(data.data);
                }
            } catch (error) {
                console.error('Erreur chargement formation:', error);
            }
        }

        async function toggleFormation(id) {
            try {
                const data = await apiCall(`/admin/formations/${id}/toggle`, { method: 'PATCH' });
                if (data && data.success) {
                    loadFormations();
                    showAlert('formationsAlert', data.message, 'success');
                }
            } catch (error) {
                console.error('Erreur toggle formation:', error);
            }
        }

        async function deleteFormation(id, title) {
            if (!confirm(`Êtes-vous sûr de vouloir supprimer la formation "${title}" ?`)) {
                return;
            }
            
            try {
                const data = await apiCall(`/admin/formations/${id}`, { method: 'DELETE' });
                if (data && data.success) {
                    loadFormations();
                    showAlert('formationsAlert', data.message, 'success');
                }
            } catch (error) {
                console.error('Erreur suppression formation:', error);
            }
        }

        // ===== TÉMOIGNAGES =====
        async function loadTestimonials() {
            const container = document.getElementById('testimonialsList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Chargement...</div>';
            
            try {
                const data = await apiCall('/testimonials/all');
                
                if (data && data.success) {
                    const testimonials = data.data;
                    
                    if (testimonials.length === 0) {
                        container.innerHTML = '<p>Aucun témoignage trouvé</p>';
                        return;
                    }
                    
                    const tableHtml = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Formation</th>
                                        <th>Note</th>
                                        <th>Message</th>
                                        <th>Statut</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${testimonials.map(testimonial => `
                                        <tr>
                                            <td><strong>${testimonial.first_name} ${testimonial.last_name}</strong></td>
                                            <td>${testimonial.formation}</td>
                                            <td>${'★'.repeat(testimonial.rating)}${'☆'.repeat(5-testimonial.rating)}</td>
                                            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                                                ${testimonial.message.substring(0, 100)}${testimonial.message.length > 100 ? '...' : ''}
                                            </td>
                                            <td>
                                                <span class="badge badge-${
                                                    testimonial.status === 'approved' ? 'success' : 
                                                    testimonial.status === 'rejected' ? 'danger' : 'warning'
                                                }">
                                                    ${testimonial.status === 'approved' ? 'Approuvé' : 
                                                      testimonial.status === 'rejected' ? 'Rejeté' : 'En attente'}
                                                </span>
                                            </td>
                                            <td>${new Date(testimonial.created_at).toLocaleDateString('fr-FR')}</td>
                                            <td>
                                                ${testimonial.status === 'pending' ? `
                                                    <button class="btn btn-success btn-sm" onclick="approveTestimonial(${testimonial.id})">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button class="btn btn-danger btn-sm" onclick="rejectTestimonial(${testimonial.id})">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                ` : '-'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    container.innerHTML = tableHtml;
                }
            } catch (error) {
                container.innerHTML = '<p class="alert alert-danger">Erreur lors du chargement</p>';
            }
        }

        async function approveTestimonial(id) {
            try {
                const data = await apiCall(`/testimonials/${id}/approve`, { method: 'PUT' });
                if (data && data.success) {
                    loadTestimonials();
                    showAlert('testimonialsAlert', data.message, 'success');
                }
            } catch (error) {
                console.error('Erreur approbation témoignage:', error);
            }
        }

        async function rejectTestimonial(id) {
            try {
                const data = await apiCall(`/testimonials/${id}/reject`, { method: 'PUT' });
                if (data && data.success) {
                    loadTestimonials();
                    showAlert('testimonialsAlert', data.message, 'success');
                }
            } catch (error) {
                console.error('Erreur rejet témoignage:', error);
            }
        }

        // ===== CONTACTS =====
        async function loadContacts() {
            const container = document.getElementById('contactsList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Chargement...</div>';
            
            try {
                const data = await apiCall('/contact/all');
                
                if (data && data.success) {
                    const contacts = data.data;
                    
                    if (contacts.length === 0) {
                        container.innerHTML = '<p>Aucun message trouvé</p>';
                        return;
                    }
                    
                    const tableHtml = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Email</th>
                                        <th>Formation d'intérêt</th>
                                        <th>Message</th>
                                        <th>Statut</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${contacts.map(contact => `
                                        <tr style="${contact.status === 'unread' ? 'background-color: #fff3cd;' : ''}">
                                            <td><strong>${contact.name}</strong></td>
                                            <td>${contact.email}</td>
                                            <td>${contact.formation_interest || '-'}</td>
                                            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                                                ${contact.message.substring(0, 100)}${contact.message.length > 100 ? '...' : ''}
                                            </td>
                                            <td>
                                                <span class="badge badge-${contact.status === 'unread' ? 'warning' : 'secondary'}">
                                                    ${contact.status === 'unread' ? 'Non lu' : 'Lu'}
                                                </span>
                                            </td>
                                            <td>${new Date(contact.created_at).toLocaleDateString('fr-FR')}</td>
                                            <td>
                                                ${contact.status === 'unread' ? `
                                                    <button class="btn btn-primary btn-sm" onclick="markContactAsRead(${contact.id})">
                                                        <i class="fas fa-check"></i> Marquer lu
                                                    </button>
                                                ` : ''}
                                                <a href="mailto:${contact.email}" class="btn btn-secondary btn-sm">
                                                    <i class="fas fa-reply"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    container.innerHTML = tableHtml;
                }
            } catch (error) {
                container.innerHTML = '<p class="alert alert-danger">Erreur lors du chargement</p>';
            }
        }

        async function markContactAsRead(id) {
            try {
                const data = await apiCall(`/contact/${id}/read`, { method: 'PUT' });
                if (data && data.success) {
                    loadContacts();
                    loadDashboard(); // Mettre à jour les compteurs
                }
            } catch (error) {
                console.error('Erreur marquage contact:', error);
            }
        }

        // ===== UTILISATEURS =====
        async function loadUsers() {
            const container = document.getElementById('usersList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Chargement...</div>';
            
            try {
                const data = await apiCall('/admin/users');
                
                if (data && data.success) {
                    const users = data.data;
                    
                    const tableHtml = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nom d'utilisateur</th>
                                        <th>Email</th>
                                        <th>Nom complet</th>
                                        <th>Rôle</th>
                                        <th>Statut</th>
                                        <th>Dernière connexion</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${users.map(user => `
                                        <tr>
                                            <td><strong>${user.username}</strong></td>
                                            <td>${user.email}</td>
                                            <td>${user.first_name || ''} ${user.last_name || ''}</td>
                                            <td>
                                                <span class="badge badge-primary">${user.role}</span>
                                            </td>
                                            <td>
                                                <span class="badge badge-${user.active ? 'success' : 'secondary'}">
                                                    ${user.active ? 'Actif' : 'Inactif'}
                                                </span>
                                            </td>
                                            <td>${user.last_login ? new Date(user.last_login).toLocaleDateString('fr-FR') : 'Jamais'}</td>
                                            <td>
                                                ${user.id !== currentUser.id ? `
                                                    <button class="btn btn-${user.active ? 'warning' : 'success'} btn-sm" 
                                                            onclick="toggleUser(${user.id})">
                                                        <i class="fas fa-${user.active ? 'pause' : 'play'}"></i>
                                                        ${user.active ? 'Désactiver' : 'Activer'}
                                                    </button>
                                                ` : '<em>Votre compte</em>'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    container.innerHTML = tableHtml;
                }
            } catch (error) {
                container.innerHTML = '<p class="alert alert-danger">Erreur lors du chargement</p>';
            }
        }

        function openUserModal() {
            document.getElementById('userModal').classList.add('show');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('show');
        }

        async function handleUserSubmit(e) {
            e.preventDefault();
            
            const formData = {
                username: document.getElementById('userUsername').value,
                email: document.getElementById('userEmail').value,
                password: document.getElementById('userPassword').value,
                first_name: document.getElementById('userFirstName').value,
                last_name: document.getElementById('userLastName').value,
                role: document.getElementById('userRole').value
            };
            
            try {
                const data = await apiCall('/admin/users', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                if (data && data.success) {
                    closeUserModal();
                    loadUsers();
                    showAlert('usersAlert', data.message, 'success');
                } else {
                    showAlert('userAlert', data.error, 'danger');
                }
            } catch (error) {
                showAlert('userAlert', 'Erreur lors de la création', 'danger');
            }
        }

        async function toggleUser(id) {
            try {
                const data = await apiCall(`/admin/users/${id}/toggle`, { method: 'PATCH' });
                if (data && data.success) {
                    loadUsers();
                    showAlert('usersAlert', data.message, 'success');
                }
            } catch (error) {
                console.error('Erreur toggle utilisateur:', error);
            }
        }

        // ===== STATISTIQUES =====
        async function loadStats() {
            const container = document.getElementById('statsContent');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Chargement...</div>';
            
            try {
                const period = document.getElementById('statsPeriod').value;
                const data = await apiCall(`/admin/stats?period=${period}`);
                
                if (data && data.success) {
                    const stats = data.data;
                    
                    let html = `
                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-number">${stats.contactsEvolution.reduce((sum, day) => sum + parseInt(day.count), 0)}</div>
                                <div class="stat-label">Contacts sur ${period} jours</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${stats.testimonialsEvolution.reduce((sum, day) => sum + parseInt(day.count), 0)}</div>
                                <div class="stat-label">Témoignages sur ${period} jours</div>
                            </div>
                        </div>
                    `;
                    
                    if (stats.topFormationsInterest.length > 0) {
                        html += `
                            <h4>Formations les plus demandées</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr><th>Formation</th><th>Demandes</th></tr>
                                    </thead>
                                    <tbody>
                                        ${stats.topFormationsInterest.map(item => `
                                            <tr>
                                                <td>${item.formation_interest}</td>
                                                <td><strong>${item.count}</strong></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    
                    container.innerHTML = html;
                }
            } catch (error) {
                container.innerHTML = '<p class="alert alert-danger">Erreur lors du chargement</p>';
            }
        }

        // ===== UTILITAIRES =====
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }

        // Fermeture des modales en cliquant à l'extérieur
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });
    </script>
</body>
</html>